(()=>{function e(e,o){return new Promise((t,n)=>{const r=e.get(o);r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result)})}function o(e,o){return new Promise((t,n)=>{const r=e.put(o);r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result)})}self.addEventListener("sync",t=>{"sync-observations"===t.tag&&t.waitUntil(async function(){try{const t=await new Promise((e,o)=>{const t=indexedDB.open("pricetag-offline",1);t.onerror=()=>o(t.error),t.onsuccess=()=>e(t.result)}),n=t.transaction("observations","readonly"),r=n.objectStore("observations").index("by-synced"),s=await function(e,o){return new Promise((t,n)=>{const r=e.getAll(o);r.onerror=()=>n(r.error),r.onsuccess=()=>t(r.result)})}(r,0);if(0===s.length)return;const i="https://costco.avocadopeanut.com",c=[];for(const e of s)try{const o=await fetch(`${i}/api/v1/sync/observation`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({observation_id:e.id,warehouse_id:e.warehouseId,item_number:e.itemNumber,price:e.price,price_ending:e.priceEnding,unit_price:e.unitPrice,unit_measure:e.unitMeasure,description:e.description,has_asterisk:e.hasAsterisk,observed_at:e.timestamp,confidence:e.confidence,source:"background_sync"})});(o.ok||o.status>=400&&o.status<500)&&c.push(e.id)}catch(o){console.error("Failed to sync observation:",e.id,o)}if(c.length>0){const n=t.transaction("observations","readwrite").objectStore("observations");for(const t of c){const r=await e(n,t);r&&(r.synced=!0,await o(n,r))}}(await self.clients.matchAll()).forEach(e=>{e.postMessage({type:"SYNC_COMPLETE",synced:c.length})})}catch(e){throw console.error("Background sync failed:",e),e}}())})})();